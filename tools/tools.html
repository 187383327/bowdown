<!DOCTYPE html>
<meta charset="utf-8">
<title>Bowdown tools</title>
<body>
<input type="file" id="files" name="files[]" multiple />
<button id="runBots">Run bots</button>
<button id="runIndexer">Run Spatial Indexer</button>
<a id="downloadAnchorElem" style="display:none"></a>
<p id="index"></p>
<output id="list"></output>
<script src="http://threejs.org/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/mrdoob/three.js@r92/examples/js/loaders/GLTFLoader.js"></script>

<script>

  const serverAddress = 'ws://localhost:18181'
  const ws = new WebSocket(serverAddress);

  var files
  function handleFileSelect(evt) {
    files = evt.target.files; // FileList object

    // files is a FileList of File objects. List some properties.
    var output = [];
    for (var i = 0, f; f = files[i]; i++) {
      output.push('<li id=' + f.name + '><strong>', escape(f.name), '</strong> (', f.type || 'n/a', ') - ',
                  f.size, ' bytes, last modified: ',
                  f.lastModifiedDate ? f.lastModifiedDate.toLocaleDateString() : 'n/a',
                  '</li>');
    }
    document.getElementById('list').innerHTML = '<ul>' + output.join('') + '</ul>';
  }

  function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
  }

  async function runBot(actions) {
    console.log("running bot")
    var action
    for (let i = 0; i < actions.length; i++) {
      action = actions[i]
      await sleep(action.elapsedTime * 1000)
      sendMessage(action.message)
      if (i == actions.length-1) i = 0 // loop forever
    }
  }

  function runBots() {
    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();
      document.getElementById(f.name).setAttribute("style", "color: green")
      reader.onload = (function (theFile) {
        return function (e) {
          console.log('e readAsText = ', e);
          console.log('e readAsText target = ', e.target);
          try {
            json = JSON.parse(e.target.result);
            runBot(json)
          } catch (ex) {
            alert('ex when trying to parse json = ' + ex);
          }
        }
      })(f);
      reader.readAsText(f);
    }
  }

  const colors = ["aqua", "blue", "chartreuse"]

  const indexMod = 5 // if you change this you need to change it in scene.js too
  function createSpatialIndex() {
    var reader = new FileReader();
    var f = files[0]
    document.getElementById(f.name).setAttribute("style", "color: blue")
    var scene = new THREE.Scene();
    var loader = new THREE.GLTFLoader();
    reader.onload = (function (theFile) {
      return function (e) {
        console.log('e readAsText = ', e);
        console.log('e readAsText target = ', e.target);
        loader.load(e.target.result, function (gltf) {
          var mesh = gltf.scene;
          scene.add(mesh);
          var spatialIndex = []
          for (var x=0; x < indexMod*2; x++) { // THERE WILL BE OVERLAP
            spatialIndex[x] = []
            for (var y=0; y < indexMod*2; y++) {
              spatialIndex[x][y] = []
              for (var z=0; z < indexMod*2; z++) {
                spatialIndex[x][y][z] = []
                var dir, ray, collisions;
                for (var w=0; w < 10000; w++) {
                  dir = new THREE.Vector3(x-indexMod+1/w, y-indexMod+1/w, z-indexMod+1/w).normalize()
                  ray = new THREE.Raycaster(new THREE.Vector3(), dir)
                  collisions = ray.intersectObject(mesh, true)
                  collisions.forEach((collision) => {
                    if (!spatialIndex[x][y][z].includes(collision.object.name)) {
                      spatialIndex[x][y][z].push(collision.object.name)
                    }
                  })
                }
                document.getElementById(f.name).setAttribute("style", "color: " + colors[Math.floor(Math.random()*colors.length)])
                console.log("indexed x: " + x + ", y: " + y + ", z: " + z)
              }
            }
          }
          var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(spatialIndex));
          var dlAnchorElem = document.getElementById('downloadAnchorElem');
          dlAnchorElem.setAttribute("href", dataStr);
          dlAnchorElem.setAttribute("download", "spatialIndex.json");
          dlAnchorElem.click();
          document.getElementById(f.name).setAttribute("style", "color: green")
        })
      }
    })(f);
    reader.readAsDataURL(f)
  }

  function sendMessage(message) {
    ws.send(JSON.stringify(message))
  }

  document.getElementById('runBots').addEventListener('click', runBots, false);
  document.getElementById('files').addEventListener('change', handleFileSelect, false);
  document.getElementById('runIndexer').addEventListener('click', createSpatialIndex, false);
</script>
</body>